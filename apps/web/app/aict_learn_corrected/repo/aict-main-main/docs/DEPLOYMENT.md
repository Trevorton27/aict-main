# Deployment Guide

## Database Setup

### ⚠️ CRITICAL: Use Separate Databases

**Never use the same database for development and production!**

### Recommended: Neon PostgreSQL Setup

You're currently using Neon, which is perfect for this project.

#### Step 1: Create Production Database

1. Go to [Neon Console](https://console.neon.tech)
2. Click "Create Project"
3. Name it: `aict-production`
4. Select region closest to your users
5. Copy the connection string

#### Step 2: Configure Environment Variables

##### Local Development (.env.local)
```bash
# Keep your current dev database
DATABASE_URL="postgresql://neondb_owner:npg_BC0FIEwfl3ae@ep-fragrant-cloud-a1ikmf8v-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require"
```

##### Production (Vercel Dashboard)
```bash
# Use NEW production database connection string
DATABASE_URL="postgresql://prod_user:prod_pass@prod-endpoint.neon.tech/aict_prod?sslmode=require"
```

#### Why Separate Databases?

| Concern | Same DB ❌ | Separate DBs ✅ |
|---------|-----------|----------------|
| Data Safety | Dev bugs delete prod data | Safe experimentation |
| Testing | Can't test destructive ops | Free to reset/seed |
| Performance | Dev queries slow prod | Independent optimization |
| Migrations | Breaking changes affect prod | Test safely first |

---

## Vercel Deployment

### Step 1: Install Vercel CLI (Optional)

```bash
npm i -g vercel
```

### Step 2: Set Environment Variables in Vercel

Go to your Vercel project dashboard → Settings → Environment Variables

#### Required Variables:

```bash
# Anthropic API Key
ANTHROPIC_API_KEY=sk-ant-api-your-production-key

# Production Database (NEW database, not dev!)
DATABASE_URL=postgresql://prod_user:prod_pass@prod-endpoint.neon.tech/aict_prod?sslmode=require

# NextAuth (generate new secret for production)
NEXTAUTH_SECRET=your-production-secret-here
NEXTAUTH_URL=https://your-domain.vercel.app
```

#### How to Generate Secrets:

```bash
# Generate NextAuth secret
openssl rand -base64 32
```

### Step 3: Initial Database Setup

After deploying, run migrations:

```bash
# Option 1: Using Vercel CLI
vercel env pull .env.production
pnpm --filter @aict/web prisma migrate deploy

# Option 2: Run from Vercel deployment
# Add this to package.json postinstall (not recommended for security)
# "postinstall": "prisma generate && prisma migrate deploy"
```

### Step 4: Deploy

```bash
# Deploy to production
vercel --prod

# Or push to main branch (auto-deploys)
git push origin main
```

---

## Database Migrations

### Development Workflow

```bash
# 1. Make schema changes in prisma/schema.prisma
# 2. Create migration
pnpm --filter @aict/web prisma migrate dev --name your_migration_name

# 3. Test locally
pnpm dev

# 4. Commit migration files
git add prisma/migrations
git commit -m "Add migration: your_migration_name"
```

### Production Deployment

```bash
# Migrations run automatically on Vercel deploy
# OR manually run:
pnpm --filter @aict/web prisma migrate deploy
```

### ⚠️ Migration Best Practices

1. **Always test migrations locally first**
2. **Never drop columns in production without backup**
3. **Use `prisma migrate deploy` in production** (not `db push`)
4. **Keep migrations reversible when possible**
5. **Backup production database before major migrations**

---

## Environment-Specific Configuration

### Development (.env.local)

```bash
# Local or Dev Neon Database
DATABASE_URL="postgresql://dev_user:dev_pass@dev-endpoint.neon.tech/aict_dev"

# Dev Anthropic Key (with lower limits)
ANTHROPIC_API_KEY="sk-ant-api-dev-key"

# Local URLs
NEXTAUTH_URL="http://localhost:3000"
NEXT_PUBLIC_APP_URL="http://localhost:3000"
```

### Staging (Vercel Preview - Optional)

```bash
# Staging Database
DATABASE_URL="postgresql://staging_user:pass@staging-endpoint.neon.tech/aict_staging"

# Staging Anthropic Key
ANTHROPIC_API_KEY="sk-ant-api-staging-key"

# Preview URL (auto-generated by Vercel)
NEXTAUTH_URL="https://your-app-preview.vercel.app"
```

### Production (Vercel Production)

```bash
# Production Database
DATABASE_URL="postgresql://prod_user:pass@prod-endpoint.neon.tech/aict_prod"

# Production Anthropic Key (with higher limits)
ANTHROPIC_API_KEY="sk-ant-api-prod-key"

# Production URL
NEXTAUTH_URL="https://your-app.vercel.app"
NEXT_PUBLIC_APP_URL="https://your-app.vercel.app"
```

---

## Neon Database Best Practices

### Connection Pooling

Neon provides connection pooling automatically. Use the pooler endpoint:

```bash
# ✅ Good: Uses connection pooler (recommended for serverless)
DATABASE_URL="postgresql://user:pass@ep-xxx-pooler.neon.tech/db?sslmode=require"

# ❌ Avoid: Direct connection (can hit connection limits)
DATABASE_URL="postgresql://user:pass@ep-xxx.neon.tech/db?sslmode=require"
```

### Connection Limits

Neon Free Tier limits:
- **Free**: 10 GB storage, 1 compute hour/day
- **Pro**: Unlimited storage, autoscaling

For production, consider:
- Monitor connection usage in Neon dashboard
- Use connection pooling (included)
- Upgrade to Pro if needed

### Backup Strategy

```bash
# Neon has automatic backups, but you can also:

# 1. Export schema
pnpm --filter @aict/web prisma db pull

# 2. Export data (from Neon Console)
# Or use pg_dump
pg_dump $DATABASE_URL > backup.sql

# 3. Restore data
psql $DATABASE_URL < backup.sql
```

---

## Monitoring & Debugging

### Check Deployment Logs

```bash
# View recent deployments
vercel logs

# View specific deployment
vercel logs [deployment-url]
```

### Database Connection Issues

```bash
# Test connection locally
psql $DATABASE_URL

# Check Prisma connection
pnpm --filter @aict/web prisma db execute --stdin < /dev/null
```

### Common Issues

#### Issue: "Can't reach database server"
**Solution**:
- Check DATABASE_URL is correct
- Verify Neon database is not suspended (free tier auto-suspends)
- Check connection pooling is enabled

#### Issue: "Prepared statement already exists"
**Solution**:
- Use connection pooler endpoint (`-pooler` in hostname)
- Add `?pgbouncer=true` to connection string

#### Issue: "Migration failed"
**Solution**:
- Never run `prisma migrate dev` in production
- Use `prisma migrate deploy` instead
- Check migration files are committed to git

---

## Security Checklist

- [ ] Separate databases for dev/staging/prod
- [ ] Different API keys per environment
- [ ] Unique NEXTAUTH_SECRET for production
- [ ] DATABASE_URL not committed to git
- [ ] .env.local in .gitignore
- [ ] Database backups configured
- [ ] SSL/TLS enabled on database connection
- [ ] Vercel environment variables set correctly
- [ ] No sensitive data in client-side code

---

## Post-Deployment Steps

1. **Verify Database Connection**
   ```bash
   # Check Vercel logs for any DB connection errors
   vercel logs
   ```

2. **Seed Production Database**
   ```bash
   # ONLY do this once for new production database
   pnpm --filter @aict/web prisma db seed
   ```

3. **Test Critical Features**
   - [ ] User can load tasks
   - [ ] Chat with AI tutor works
   - [ ] Code editor loads
   - [ ] Tests run successfully
   - [ ] Progress tracking works

4. **Monitor Performance**
   - Check Vercel Analytics
   - Monitor Neon database metrics
   - Check Anthropic API usage

---

## Rollback Strategy

If something goes wrong:

```bash
# 1. Revert to previous Vercel deployment
vercel rollback

# 2. Or redeploy previous git commit
git revert HEAD
git push origin main

# 3. Restore database from backup if needed
psql $DATABASE_URL < backup.sql
```

---

## Cost Optimization

### Neon Free Tier Limits
- 10 GB storage
- 1 compute hour per day
- Auto-suspend after inactivity

### Upgrade Triggers
- Traffic > 1 hour compute/day
- Database > 10 GB
- Need always-on database

### Anthropic API Costs
- Monitor usage in Anthropic Console
- Set usage limits
- Consider caching responses

---

## Support & Resources

- **Neon Docs**: https://neon.tech/docs
- **Vercel Docs**: https://vercel.com/docs
- **Prisma Docs**: https://www.prisma.io/docs
- **Anthropic Docs**: https://docs.anthropic.com

---

## Quick Reference

| Task | Command |
|------|---------|
| Deploy to Vercel | `vercel --prod` |
| Check logs | `vercel logs` |
| Run migrations | `pnpm --filter @aict/web prisma migrate deploy` |
| Seed database | `pnpm db:seed` |
| Rollback | `vercel rollback` |
| Backup DB | `pg_dump $DATABASE_URL > backup.sql` |
| Test connection | `psql $DATABASE_URL` |
