# Deployment Checklist for Vercel

## ‚úÖ Pre-Deployment Checklist

### 1. Environment Variables in Vercel Dashboard

Go to [Vercel Dashboard](https://vercel.com/dashboard) ‚Üí Your Project ‚Üí Settings ‚Üí Environment Variables

#### Required Variables:

- [ ] **ANTHROPIC_API_KEY**
  - Value: `sk-ant-api-...`
  - Environments: ‚òë Production, ‚òë Preview, ‚òë Development

- [ ] **DATABASE_URL**
  - Value: `postgresql://...`
  - ‚ö†Ô∏è Use SEPARATE database for production!
  - Environments: ‚òë Production (different from dev!)

- [ ] **NEXTAUTH_SECRET**
  - Generate: `openssl rand -base64 32`
  - Environments: ‚òë Production, ‚òë Preview, ‚òë Development

- [ ] **NEXTAUTH_URL**
  - Production: `https://your-app.vercel.app`
  - Environment: ‚òë Production

### 2. Repository Files

- [ ] Committed latest changes
- [ ] No `package-lock.json` files (only `pnpm-lock.yaml`)
- [ ] `.vercelignore` exists
- [ ] `vercel.json` configured correctly
- [ ] `.env.local` NOT committed to git

### 3. Vercel Project Settings

Go to Settings ‚Üí General:

- [ ] **Root Directory**: Leave blank (or set to repo root)
- [ ] **Framework Preset**: Next.js
- [ ] **Node.js Version**: 18.x or 20.x

Go to Settings ‚Üí Build & Development Settings:

- [ ] **Build Command**: `cd apps/web && pnpm prisma generate && pnpm build`
- [ ] **Install Command**: `pnpm install`
- [ ] **Output Directory**: `apps/web/.next`

---

## üöÄ Deployment Steps

### Step 1: Final Code Check

```bash
# Make sure everything is committed
git status

# Check for package-lock.json (should not exist)
find . -name "package-lock.json" -not -path "*/node_modules/*"

# If found, remove them:
rm -f package-lock.json packages/*/package-lock.json
```

### Step 2: Test Build Locally

```bash
# Install dependencies
pnpm install

# Generate Prisma client
cd apps/web && pnpm prisma generate

# Build
pnpm build

# Should complete without errors
```

### Step 3: Commit and Push

```bash
# Stage changes
git add .

# Commit
git commit -m "chore: Prepare for Vercel deployment"

# Push to main
git push origin main
```

### Step 4: Monitor Deployment

1. Go to [Vercel Dashboard](https://vercel.com/dashboard)
2. Click on your project
3. Go to **Deployments** tab
4. Watch the build progress

---

## üîç Expected Build Output

### ‚úÖ Successful Build

You should see:

```
‚úì Detected pnpm-lock.yaml version 6 generated by pnpm@8.x
‚úì Running "install" command: pnpm install
‚úì Installing dependencies...
‚úì Running "build" command: cd apps/web && pnpm prisma generate && pnpm build
‚úì Environment variables loaded from Vercel
‚úì Prisma schema loaded from prisma/schema.prisma
‚úì Generated Prisma Client
‚úì Compiling Next.js...
‚úì Compiled successfully
‚úì Linting and checking validity of types
‚úì Collecting page data
‚úì Generating static pages
‚úì Finalizing page optimization
‚úì Build completed successfully
‚úì Uploading build outputs
‚úì Deployment ready
```

### ‚ùå Common Errors

#### Error: "Could not identify Next.js version"
**Fix**: Ensure `next` is in `apps/web/package.json` dependencies

#### Error: "ANTHROPIC_API_KEY is not defined"
**Fix**: Add to Vercel Environment Variables in dashboard

#### Error: "fatal: ambiguous argument './apps/web'"
**Fix**: Remove `ignoreCommand` from vercel.json (already done)

#### Error: "Prisma Client not generated"
**Fix**: Ensure build command includes `pnpm prisma generate`

---

## üéØ Post-Deployment Tasks

### 1. Verify Deployment

- [ ] Visit your production URL: `https://your-app.vercel.app`
- [ ] Check homepage loads
- [ ] Navigate to `/learn`
- [ ] Test AI tutor interaction

### 2. Check Function Logs

1. Go to Deployments ‚Üí [Latest Deployment]
2. Click **"View Function Logs"**
3. Look for any errors

### 3. Test API Endpoints

```bash
# Test tutor endpoint
curl https://your-app.vercel.app/api/tutor \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{"userText":"Hello","context":{}}'

# Test tasks endpoint
curl https://your-app.vercel.app/api/tasks

# Should return valid JSON
```

### 4. Database Setup (First Time Only)

If this is your first production deployment:

```bash
# Option 1: Using Vercel CLI
vercel env pull .env.production
cd apps/web
pnpm prisma migrate deploy
pnpm prisma db seed

# Option 2: Using Prisma Studio
# Connect to production database and manually seed
```

### 5. Monitor Performance

- [ ] Check Vercel Analytics dashboard
- [ ] Monitor Neon database metrics
- [ ] Check Anthropic API usage

---

## üõ†Ô∏è Troubleshooting

### Build Fails

1. **Check build logs** in Vercel dashboard
2. **Look for error message** - usually very specific
3. **Common fixes**:
   - Add missing environment variables
   - Fix TypeScript errors
   - Ensure all dependencies installed

### Deployment Succeeds but Site Doesn't Work

1. **Check Function Logs**: Deployments ‚Üí View Function Logs
2. **Look for runtime errors**:
   - Database connection issues
   - Missing API keys
   - Prisma client not generated
3. **Test locally** with production env vars:
   ```bash
   vercel env pull .env.production
   pnpm dev
   ```

### Database Connection Issues

1. **Verify DATABASE_URL** in Vercel
2. **Check database is running** in Neon dashboard
3. **Test connection**:
   ```bash
   psql $DATABASE_URL
   ```
4. **Ensure connection pooling** (use `-pooler` endpoint)

---

## üìä Environment-Specific Configuration

### Production
- **Database**: Separate production Neon database
- **API Key**: Production Anthropic key (higher limits)
- **URL**: `https://your-app.vercel.app`

### Preview (Branch Deploys)
- **Database**: Staging/preview database
- **API Key**: Staging Anthropic key
- **URL**: Auto-generated by Vercel

### Development
- **Database**: Development database
- **API Key**: Development Anthropic key
- **URL**: `http://localhost:3000`

---

## üîÑ Continuous Deployment

### Auto-Deploy on Push

Once configured, Vercel will automatically:
1. Detect push to `main` branch
2. Run build
3. Deploy to production
4. Run health checks

### Branch Previews

- Push to any other branch creates a Preview deployment
- Perfect for testing before merging to main
- Each preview gets unique URL

---

## üîí Security Checklist

- [ ] Separate databases for dev/prod
- [ ] Different API keys per environment
- [ ] Unique NEXTAUTH_SECRET
- [ ] DATABASE_URL not in git
- [ ] .env.local in .gitignore
- [ ] API rate limits configured
- [ ] Database backups enabled

---

## üìù Rollback Plan

If something goes wrong:

### Option 1: Instant Rollback in Vercel
1. Go to Deployments
2. Find previous working deployment
3. Click **"..."** ‚Üí **"Promote to Production"**

### Option 2: Git Revert
```bash
git revert HEAD
git push origin main
```

### Option 3: Redeploy Specific Commit
1. Go to Deployments
2. Find working commit
3. Click **"Redeploy"**

---

## üéâ Success Criteria

Your deployment is successful when:

- ‚úÖ Build completes without errors
- ‚úÖ Site loads at production URL
- ‚úÖ All pages render correctly
- ‚úÖ AI tutor responds to queries
- ‚úÖ Database connections work
- ‚úÖ No errors in Function Logs
- ‚úÖ API endpoints return valid data
- ‚úÖ Environment variables accessible

---

## üìö Related Docs

- [VERCEL_FIX.md](./VERCEL_FIX.md) - Build fixes
- [ANTHROPIC_API_KEY_FIX.md](./ANTHROPIC_API_KEY_FIX.md) - API key setup
- [VERCEL_ENVIRONMENT_SETUP.md](./VERCEL_ENVIRONMENT_SETUP.md) - Multi-environment setup
- [DEPLOYMENT.md](./DEPLOYMENT.md) - General deployment guide

---

## üÜò Still Having Issues?

1. Check [Vercel Status Page](https://www.vercel-status.com/)
2. Review deployment logs carefully
3. Test build locally first
4. Verify all environment variables
5. Check Neon database is accessible
6. Ensure Anthropic API key is valid

**Common Command Reference:**
```bash
# Test local build
pnpm install && cd apps/web && pnpm prisma generate && pnpm build

# Check for npm lock files
find . -name "package-lock.json" -not -path "*/node_modules/*"

# Pull production env vars
vercel env pull .env.production

# Force redeploy
git commit --allow-empty -m "Force redeploy" && git push

# View logs
vercel logs --prod
```

Good luck! üöÄ
